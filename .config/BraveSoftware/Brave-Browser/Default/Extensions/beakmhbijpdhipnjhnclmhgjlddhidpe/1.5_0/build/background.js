!function(){"use strict";function t(){return"undefined"!=typeof browser?browser:chrome}function e(){return"undefined"!=typeof chrome&&!!chrome.storage}function n(t){if(e()){return chrome.storage.local.get([t]).then((e=>e[t]))}return Promise.resolve(localStorage.getItem(t))}const o={baseUrl:"",token:"",default_tags:""};async function r(){const t=await n("ld_ext_config"),e=t?JSON.parse(t):{};return{...o,...e}}function a(t){return t.baseUrl&&t.token}class s{constructor(t){this.configuration=t}async getBookmark(t){const e=this.configuration;return fetch(`${e.baseUrl}/api/bookmarks/${t}/`,{headers:{Authorization:`Token ${e.token}`}}).then((t=>200===t.status?t.json():Promise.reject(`Error retrieving bookmark: ${t.statusText}`)))}async saveBookmark(t){const e=this.configuration;return fetch(`${e.baseUrl}/api/bookmarks/`,{method:"POST",headers:{Authorization:`Token ${e.token}`,"Content-Type":"application/json"},body:JSON.stringify(t)}).then((t=>201===t.status?t.json():400===t.status?t.json().then((t=>Promise.reject(`Validation error: ${JSON.stringify(t)}`))):Promise.reject(`Request error: ${t.statusText}`)))}async getTags(){const t=this.configuration;return fetch(`${t.baseUrl}/api/tags/?limit=1000`,{headers:{Authorization:`Token ${t.token}`}}).then((t=>200===t.status?t.json().then((t=>t.results)):Promise.reject(`Error loading tags: ${t.statusText}`)))}async search(t,e){const n=this.configuration,o=encodeURIComponent(t),r=e.limit||100;return fetch(`${n.baseUrl}/api/bookmarks/?q=${o}&limit=${r}`,{headers:{Authorization:`Token ${n.token}`}}).then((t=>200===t.status?t.json().then((t=>t.results)):Promise.reject(`Error searching bookmarks: ${t.statusText}`)))}async check(t){const e=this.configuration;return t=encodeURIComponent(t),fetch(`${e.baseUrl}/api/bookmarks/check/?url=${t}`,{headers:{Authorization:`Token ${e.token}`}}).then((t=>200===t.status?t.json():Promise.reject(`Error checking bookmark URL: ${t.statusText}`)))}async testConnection(){const t=this.configuration;return fetch(`${t.baseUrl}/api/bookmarks/?limit=1`,{headers:{Authorization:`Token ${t.token}`}}).then((t=>200===t.status?t.json():Promise.reject(t))).then((t=>!!t.results)).catch((()=>!1))}async findBookmarkByUrl(t){return this.search(t,{limit:1}).then((t=>t&&t.length>0?t[0]:void 0))}}const i="ld_tab_metadata_cache";async function c(t){const o=await r();if(!a(o)||!t||!t.match(/^http(s)?:\/\//))return null;const c=await async function(){const t=await n(i);return t?JSON.parse(t):null}();if(c&&c.metadata.url===t)return c;const u=new s(o);try{const n=await u.check(t);return n.bookmark&&!n.bookmark.date_added&&(n.bookmark=await u.getBookmark(n.bookmark.id)),await async function(t){const n=JSON.stringify(t);await(o=i,r=n,e()?chrome.storage.local.set({[o]:r}):(localStorage.setItem(o,r),Promise.resolve()));var o,r}(n),n}catch(t){return console.error(t),null}}const u=t();let l=null,h=null,k=!1;u.omnibox.onInputStarted.addListener((async()=>{const t=await async function(){return!!l||(h=await r(),k=a(h),l=k?new s(h):null,null!==l)}()?"Search bookmarks in linkding":"⚠️ Please configure the linkding extension first";u.omnibox.setDefaultSuggestion({description:t})})),u.omnibox.onInputChanged.addListener(((t,e)=>{l&&l.search(t,{limit:5}).then((t=>{const n=t.map((t=>({content:t.url,description:t.title||t.website_title||t.url})));e(n)})).catch((t=>{console.error(t)}))})),u.omnibox.onInputEntered.addListener(((t,e)=>{if(!k||!t)return;const n=/^http(s)?:\/\//.test(t)?t:`${h.baseUrl}/bookmarks?q=${encodeURIComponent(t)}`;switch(e){case"currentTab":u.tabs.update({url:n});break;case"newForegroundTab":u.tabs.create({url:n});break;case"newBackgroundTab":u.tabs.create({url:n,active:!1})}})),u.tabs.onActivated.addListener((async()=>{const e=await async function(){const e=await t().tabs.query({active:!0,currentWindow:!0}),n=e&&e[0];return{url:n?n.url:"",title:n?n.title:""}}();await c(e.url)})),u.tabs.onUpdated.addListener((async(t,e,n)=>{e.url&&n.active&&await c(n.url)}))}();
//# sourceMappingURL=background.js.map
